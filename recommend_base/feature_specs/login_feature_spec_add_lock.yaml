# recommend_base/{feature_id}_feature_spec.yaml
feature_id: login
name: "ë¡œê·¸ì¸ ê¸°ëŠ¥"
domain: "auth"

summary: >
  ì‚¬ìš©ìê°€ ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¡œ ë¡œê·¸ì¸í•˜ëŠ” ê¸°ëŠ¥.
  ë¡œê·¸ì¸ ì„±ê³µ ì‹œ accessTokenê³¼ userIdë¥¼ ë°˜í™˜í•œë‹¤.

owner:
  pm: "í™ê¸¸ë™"
  dev: "ê¹€ê°œë°œ"
  qa: "ì´í…ŒìŠ¤í„°"

# ----------------------------------------------------------------------
# 1) API ìš”ì•½ (ë¯¸ë‹ˆ ìŠ¤í™) - ì—¬ê¸°ë§Œ ì±„ì›Œë„ api.yaml ë½‘ì„ ìˆ˜ ìˆê²Œ
# ----------------------------------------------------------------------
api:
  path: "/api/login_api"
  method: POST
  summary: "ì‚¬ìš©ì ë¡œê·¸ì¸ API"
  tags: ["auth", "login"]

  request:
    description: "ë¡œê·¸ì¸ ìš”ì²­ ë°”ë””"
    fields:
      - name: email
        type: string
        format: email
        required: true
        description: "ë¡œê·¸ì¸ ì´ë©”ì¼"
      - name: password
        type: string
        required: true
        description: "ë¡œê·¸ì¸ ë¹„ë°€ë²ˆí˜¸"

  responses:
    - name: success
      http_status: 200
      description: "ë¡œê·¸ì¸ ì„±ê³µ"
      body:
        type: object
        fields:
          - name: accessToken
            type: string
            description: "ì•¡ì„¸ìŠ¤ í† í°"
          - name: userId
            type: string
            description: "ì‚¬ìš©ì ID"

    - name: invalid_input
      http_status: 400
      description: "ìš”ì²­ ê°’ ì˜¤ë¥˜"
      error_code: "INVALID_PASSWORD_FORMAT"   # ëŒ€í‘œ ì—ëŸ¬ ì½”ë“œ
      body:
        type: object
        fields:
          - name: errorCode
            type: string

    - name: login_failed
      http_status: 401
      description: "ì¸ì¦ ì‹¤íŒ¨(ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜)"
      error_code: "LOGIN_FAILED"
      body:
        type: object
        fields:
          - name: errorCode
            type: string

    - name: account_locked
      http_status: 401
      description: "ê³„ì • ì ê¹€ ìƒíƒœ"
      error_code: "ACCOUNT_LOCKED"
      body:
        type: object
        fields:
          - name: errorCode
            type: string

# ----------------------------------------------------------------------
# 2) DB êµ¬ì¡° (db_schema.yamlìš© ë¯¸ë‹ˆ ìŠ¤í™)
# ----------------------------------------------------------------------
db:
  dbms: "mysql"
  version: "8.0"
  schema: "ssot"
  charset: "utf8mb4"
  tables:
    - name: "tbl_member"
      description: "íšŒì› ì •ë³´"
      primary_key: ["user_id"]
      columns:
        - name: "user_id"
          type: string
          length: 20
          nullable: false
          description: "ì‚¬ìš©ì ID"

        - name: "email"
          type: string
          length: 255
          nullable: false
          unique: true
          description: "ì´ë©”ì¼"

        - name: "password_hash"
          type: string
          length: 255
          nullable: false
          description: "ë¹„ë°€ë²ˆí˜¸ í•´ì‹œ"

        # ğŸ”½ ê³„ì • ì ê¸ˆ ë¡œì§ì„ ìœ„í•œ ì¶”ê°€ ì»¬ëŸ¼ë“¤
        - name: "fail_count"
          type: integer
          nullable: false
          default: 0
          description: "ì—°ì† ë¡œê·¸ì¸ ì‹¤íŒ¨ íšŸìˆ˜"

        - name: "is_locked"
          type: boolean
          nullable: false
          default: false
          description: "ê³„ì • ì ê¸ˆ ì—¬ë¶€"

        - name: "locked_at"
          type: datetime
          nullable: true
          description: "ê³„ì • ì ê¸ˆ ì‹œê°"

        - name: "created_at"
          type: datetime
          nullable: false

        - name: "updated_at"
          type: datetime
          nullable: false

# ----------------------------------------------------------------------
# 3) ê²€ì¦/ì—…ë¬´ RULE (rules.yaml + validation_schema.json ê³µí†µ ì›ë³¸)
# ----------------------------------------------------------------------
validation:
  fields:
    email:
      type: string
      required: true
      format: email
      max_length: 255
      errors:
        invalid_format: "INVALID_EMAIL_FORMAT"
        required: "MISSING_REQUIRED_FIELD"

    password:
      type: string
      required: true
      min_length: 8
      pattern: "(?=.*[A-Z])(?=.*[a-z])(?=.*\\d)(?=.*[!@#$%^&*]).{8,}"
      description: "ëŒ€ë¬¸ì/ì†Œë¬¸ì/ìˆ«ì/íŠ¹ìˆ˜ë¬¸ìë¥¼ ëª¨ë‘ í¬í•¨í•œ 8ìë¦¬ ì´ìƒ"
      errors:
        invalid_format: "INVALID_PASSWORD_FORMAT"
        required: "MISSING_REQUIRED_FIELD"

business_rules:
  login:
    description: "ì´ë©”ì¼ + ë¹„ë°€ë²ˆí˜¸ë¡œ ë¡œê·¸ì¸"
    fail_error_code: "LOGIN_FAILED"

    # ğŸ”½ ì‹ ê·œ ì¶”ê°€: ê³„ì • ì ê¸ˆ ì •ì±…
    max_fail_count: 5           # ì—°ì† ë¡œê·¸ì¸ ì‹¤íŒ¨ í—ˆìš© íšŸìˆ˜
    lock_on_fail: true          # í—ˆìš© íšŸìˆ˜ ì´ˆê³¼ ì‹œ ê³„ì • ì ê¸ˆ ì—¬ë¶€
    lock_error_code: "ACCOUNT_LOCKED"

    notes:
      - "ë¡œê·¸ì¸ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì—°ì† 5íšŒ í‹€ë¦¬ë©´ ê³„ì •ì„ ì ê¸ˆ ì²˜ë¦¬í•œë‹¤."
      - "ì ê¸ˆ ìƒíƒœì—ì„œëŠ” ë¡œê·¸ì¸ ìš”ì²­ ì‹œ í•­ìƒ ACCOUNT_LOCKED ì—ëŸ¬ë¥¼ ë°˜í™˜í•œë‹¤."

# ----------------------------------------------------------------------
# 4) í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ (testcases.yaml ì›ë³¸)
# ----------------------------------------------------------------------
testcases:
  - id: "TC_LOGIN_001"
    type: "api"
    name: "ì •ìƒ ë¡œê·¸ì¸"
    precondition: "DBì— user1@example.com / Pass@word1 ê³„ì •ì´ ì¡´ì¬"
    input:
      email: "user1@example.com"
      password: "Pass@word1"
    expected:
      http_status: 200
      body:
        has_fields: ["accessToken", "userId"]

  - id: "TC_LOGIN_002"
    type: "api"
    name: "ì˜ëª»ëœ ë¹„ë°€ë²ˆí˜¸"
    precondition: "DBì— user1@example.com / Pass@word1 ê³„ì •ì´ ì¡´ì¬"
    input:
      email: "user1@example.com"
      password: "WrongPass!1"
    expected:
      http_status: 401
      body:
        errorCode: "LOGIN_FAILED"

  - id: "TC_LOGIN_003"
    type: "api"
    name: "ë¹„ë°€ë²ˆí˜¸ í˜•ì‹ ì˜¤ë¥˜"
    input:
      email: "user1@example.com"
      password: "short"
    expected:
      http_status: 400
      body:
        errorCode: "INVALID_PASSWORD_FORMAT"

  - id: "TC_LOGIN_004"
    type: "api"
    name: "5íšŒ ì—°ì† ë¡œê·¸ì¸ ì‹¤íŒ¨ í›„ ê³„ì • ì ê¹€"
    precondition: >
      DBì— user1@example.com / Pass@word1 ê³„ì •ì´ ì¡´ì¬í•˜ê³ ,
      ì´ˆê¸° fail_count = 0, is_locked = false ìƒíƒœì—¬ì•¼ í•¨.
    steps:
      - description: "1~4ë²ˆì§¸ ë¡œê·¸ì¸ ì‹¤íŒ¨ (LOGIN_FAILED ìœ ì§€)"
        repeat: 4
        input:
          email: "user1@example.com"
          password: "WrongPass!1"
        expected:
          http_status: 401
          body:
            errorCode: "LOGIN_FAILED"

      - description: "5ë²ˆì§¸ ë¡œê·¸ì¸ ì‹¤íŒ¨ ì‹œ ê³„ì • ì ê¹€ ë°œìƒ"
        input:
          email: "user1@example.com"
          password: "WrongPass!1"
        expected:
          http_status: 401
          body:
            errorCode: "ACCOUNT_LOCKED"
